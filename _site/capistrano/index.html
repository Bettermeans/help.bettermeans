<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Help.Bettermeans - Deploying with Capistrano</title>
    <link rel="stylesheet" href="/css/style.css" type="text/css" media="screen" charset="utf-8"/>
    <link rel="stylesheet" href="/css/print.css" type="text/css" media="print">
  </head>

  <body>
    
      
        <script type="text/javascript">var main_category = "deploying"</script>
      
    
    <div id="main">
      <div id="header" class="basic">
        <div class="site">
          <div class="logo boring">
            <a href="/"><img src="/images/help.github.png" alt="bettermeans learn logo" /></a>
          </div>
          <div class="topsearch">
            <ul class="nav logged_out">
              <!-- <li><a href="http://gitref.org/">Git Reference</a></li>
              <li><a href="http://bettermeans.com/bettermeans/help.bettermeans.com#readme">Contribute</a></li>
              <li><a href="http://support.bettermeans.com/">Support</a></li> -->
              <li><a href="http://bettermeans.com/">Back to Bettermeans</a></li>
            </ul>
          </div>
        </div>
      </div>

      <div id="content" class="site">
        <div id="guides">
          <div class="guide">
            <div class="main">
              <h1>Deploying with Capistrano</h1>

              <div class="wikistyle">
                <p>To prepare your project for <a href="http://www.capify.org/">Capistrano</a>, go into the root directory of that project and run <code>capify</code>:</p>
<pre class="terminal">
$ cd my_project
$ capify .
</pre>
<h2>Generate Public Key</h2>
<p>It would probably be a good idea to add a special user on your server(s) specifically for deployment.  Once created, make sure to generate a public key for the server and add it to your github account.  You may also want to add your personal public key to this new user&#8217;s <code>~/.ssh/authorized_keys</code> to ease deployment.</p>
<p>For more help with deploy keys, see <a href="/deploy-keys">this guide</a>.</p>
<h2>Settings</h2>
<p>Here are the 5 most notable Capistrano config options (found in deploy.rb):</p>
<pre>
default_run_options[:pty] = true  # Must be set for the password prompt from git to work
set :repository, "git@github.com:vanpelt/rails-app.git"  # Your clone URL
set :scm, "git"
set :user, "deployer"  # The server's user for deploys
set :scm_passphrase, "p@ssw0rd"  # The deploy user's password
</pre>
<h3>Agent Forwarding</h3>
<p>If you&#8217;re using your own private keys for git you might want to tell Capistrano to use agent forwarding with this command.  Agent forwarding can make key management much simpler as it uses your local keys instead of keys installed on the server.</p>
<pre>ssh_options[:forward_agent] = true</pre>
<h3>Set Branch</h3>
<p>You need to tell cap the branch to checkout during deployment:</p>
<pre>set :branch, "master"</pre>
<p>Older versions of cap need the full branch name:</p>
<pre>set :branch, "origin/master"</pre>
<p>Older versions of git (e.g. 1.4.4.2) don&#8217;t support <code>git checkout -q</code>, this will cause your deployment to fail.  To fix either upgrade git or:</p>
<pre>set :scm_verbose, true</pre>
<h3>Remote Cache</h3>
<p>In most cases you want to use this option, otherwise each deploy will do a full repository clone every time.</p>
<pre>set :deploy_via, :remote_cache</pre>
<p>Remote caching will keep a local git repo on the server you&#8217;re deploying to and simply run a fetch from that rather than an entire clone.  This is probably the best option as it will only fetch the changes since the last.</p>
<h3>Shallow Clone</h3>
<p>As an alternative to the remote cache approach, you can use shallow cloning.</p>
<pre>set :git_shallow_clone, 1</pre>
<p>Shallow cloning will do a clone each time, but will only get the top commit, not the entire repo.  This makes it a bit closer to how an svn checkout works.  Be warned, shallow clone won&#8217;t work well with the <code>set :branch</code> option.</p>
<h3>Submodules</h3>
<p>If you&#8217;re using git submodules you must tell cap to fetch them.</p>
<pre>set :git_enable_submodules, 1</pre>
<h2>Migrating from <span class="caps">SVN</span></h2>
<p>Migrating from <span class="caps">SVN</span>-based deploys?  <a href="http://groups.google.com/group/github/browse_frm/thread/c5d2620c541e4e1a">Check this thread</a> if you run into any problems.</p>
<h2>Known Hosts bug</h2>
<p>If you are not using agent forwarding, the first time you deploy may fail due to Capistrano not prompting with this message:</p>
<pre class="terminal">
The authenticity of host 'github.com (207.97.227.239)' can't be established.
RSA key fingerprint is 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48.
Are you sure you want to continue connecting (yes/no)?
</pre>
<p>To fix this, ssh into your server as the user you will deploy with, run <code>ssh git@github.com</code> and confirm the prompt.</p>
              </div>
            </div>

            <div class="sidebar">
              
                <h3>Getting started</h3>
                  <ul id="categories">
                    
                  </ul>
              
                <h3>Guides</h3>
                  <ul id="categories">
                    
                      
                        <li><a href="/voting" id="guides">Dashboard</a></li>
                      
                    
                  </ul>
              
                <h3>Faq</h3>
                  <ul id="categories">
                    
                  </ul>
              
                <h3>Popular</h3>
                  <ul id="categories">
                    
                      
                        <li><a href="/forking" id="popular">Forking a project</a></li>
                      
                    
                      
                        <li><a href="/key-setup-redirect" id="popular">Generating SSH keys</a></li>
                      
                    
                      
                        <li><a href="/troubleshooting-common-issues" id="popular">Common issues and questions</a></li>
                      
                    
                      
                        <li><a href="/troubleshooting-ssh" id="popular">Troubleshooting SSH issues</a></li>
                      
                    
                      
                        <li><a href="/git-email-settings" id="popular">Setting user name, email and GitHub token</a></li>
                      
                    
                      
                        <li><a href="/removing-sensitive-data" id="popular">Removing sensitive data</a></li>
                      
                    
                      
                        <li><a href="/voting" id="popular">Dashboard</a></li>
                      
                    
                  </ul>
              
            </div>
          </div>
        </div>
      </div>
      <div class="push"></div>
    </div>

    <div id="footer">
      <div class="site">

        <div class="info">
          <div class="links">
            <a href="http://bettermeans.org/front/?cat=3"><b>Blog</b></a> |
            <a href="http://bettermeans.org/front/?page_id=284">Contact</a> |
            <a href="http://twitter.com/bettermeans">Twitter</a> |
            <a href="http://bettermeans.com/front/user_agreement.html">Terms of Service</a> | 
            <a href="http://bettermeans.com/front/privacy.html">Privacy Policy</a>
          </div>
          <div class="company">
           &copy;&copy;
            2010
            Bettermeans LLC.
            <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/us/" rel="license">
            Creative Commons Attribution-Noncommercial-Share Alike 3.0 License</a>
           
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
